<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Real vs TTS Listening Test (5 pairs)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 2rem auto; line-height: 1.5; }
    h2 { text-align: center; }
    .trial { border: 1px solid #ccc; padding: 1rem; margin-bottom: 1rem; border-radius: 6px; }
    .options { margin-top: 0.5rem; }
    .options label { margin-right: 1rem; }
    audio { display: block; margin: 0.5rem 0; width: 100%; }
    button { padding: 0.6rem 1rem; margin-top: 1rem; }
    .note { color:#555; font-size: 0.9rem; margin-top:1rem; }
    .success { color: green; }
    .error { color: #b00020; }
    .missing { border-color: #b00020; box-shadow: 0 0 0 2px rgba(176,0,32,.12); }
  </style>
</head>
<body>
  <h2>Real vs TTS Listening Test</h2>
  <p>Listen to each pair. <strong>Select which clip is REAL</strong> (Top or Bottom), or choose ‚ÄúI don't know‚Äù. All items are required.</p>

  <label>
    Your alias: <input type="text" id="alias" placeholder="Enter your alias" required>
  </label>

  <div id="survey"></div>

  <button id="submitBtn" onclick="submitResults()">Submit</button>
  <div class="note" id="status"></div>

<script>
  // üîó Google Apps Script Web App URL (yours)
  const SHEETS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwTMA-iDooRLuimcHGsb9FKSbtUmHy8y3zYbF5xXJN7wAx6pu69QPY1MqpFSFf4FZfp/exec';

  // Five pairs (normalized)
  const trials = [
    { id: "n10", real: "audio/real_norm/10.wav", tts: "audio/fake_norm/10.wav" },
    { id: "n11", real: "audio/real_norm/11.wav", tts: "audio/fake_norm/11.wav" },
    { id: "n14", real: "audio/real_norm/14.wav", tts: "audio/fake_norm/14.wav" },
    { id: "n15", real: "audio/real_norm/15.wav", tts: "audio/fake_norm/15.wav" },
    { id: "n18", real: "audio/real_norm/18.wav", tts: "audio/fake_norm/18.wav" }
  ];

  const container = document.getElementById("survey");

  // Track which label/source appears on top/bottom for each trial
  const topLabel = {};   // e.g., { n10: 'real'|'tts' }
  const bottomLabel = {};
  const topSrc = {};
  const bottomSrc = {};

  // Build trials (randomise which is top/bottom)
  trials.forEach((t, i) => {
    const div = document.createElement("div");
    div.className = "trial";
    div.setAttribute('data-trial', t.id);

    const pair = [
      { label: 'real', src: t.real },
      { label: 'tts',  src: t.tts  }
    ];
    if (Math.random() > 0.5) pair.reverse();

    // record mapping for logging/correctness
    topLabel[t.id]    = pair[0].label;
    bottomLabel[t.id] = pair[1].label;
    topSrc[t.id]      = pair[0].src;
    bottomSrc[t.id]   = pair[1].src;

    div.innerHTML = `
      <h3>Trial ${i+1}</h3>
      <div><strong>Top:</strong> <audio controls src="${pair[0].src}"></audio></div>
      <div><strong>Bottom:</strong> <audio controls src="${pair[1].src}"></audio></div>
      <div class="options">
        <label><input type="radio" name="${t.id}" value="Top"> Top is REAL</label>
        <label><input type="radio" name="${t.id}" value="Bottom"> Bottom is REAL</label>
        <label><input type="radio" name="${t.id}" value="Not sure"> I don't know</label>
      </div>
    `;
    container.appendChild(div);
  });

  function submitResults(){
    const alias = (document.getElementById("alias").value || "").trim();
    const statusEl = document.getElementById("status");
    if (!alias) {
      alert("Please enter your alias before submitting.");
      return;
    }

    // Require an answer for every trial
    const unanswered = [];
    trials.forEach(t => {
      const selected = document.querySelector(`input[name="${t.id}"]:checked`);
      const block = document.querySelector(`.trial[data-trial="${t.id}"]`);
      if (!selected) {
        unanswered.push(t.id);
        block && block.classList.add('missing');
      } else {
        block && block.classList.remove('missing');
      }
    });
    if (unanswered.length > 0) {
      statusEl.innerHTML = `<span class="error">Please answer all items (${unanswered.length} missing). The first missing item has been highlighted.</span>`;
      const first = document.querySelector(`.trial[data-trial="${unanswered[0]}"]`);
      first && first.scrollIntoView({behavior: 'smooth', block: 'center'});
      return;
    }

    // Build payload for Google Sheets (full detail + correctness)
    const payload = trials.map(t => {
      const selected = document.querySelector(`input[name="${t.id}"]:checked`).value; // 'Top' | 'Bottom' | 'Not sure'
      const isCorrect =
        (selected === 'Top'    && topLabel[t.id] === 'real') ||
        (selected === 'Bottom' && bottomLabel[t.id] === 'real')
          ? 'Correct' : 'Incorrect';

      return {
        alias: alias,
        trial_id: t.id,
        response: selected,
        top_label: topLabel[t.id],     // 'real' or 'tts'
        bottom_label: bottomLabel[t.id],
        top_src: topSrc[t.id],
        bottom_src: bottomSrc[t.id],
        is_correct: selected === 'Not sure' ? 'Incorrect' : isCorrect
      };
    });

    // Send to Google Sheets
    statusEl.textContent = "Submitting‚Ä¶ please wait.";
    fetch(SHEETS_ENDPOINT, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    }).catch(() => {
      // even if it errors in the browser due to no-cors, Apps Script likely receives it
    }).finally(() => {
      statusEl.innerHTML = "<span class='success'>Submitted! A backup CSV has been downloaded.</span>";

      // Download a minimal CSV for the participant
      const rows = [["Alias","TrialID","Response"]];
      payload.forEach(r => rows.push([r.alias, r.trial_id, r.response]));
      const csv = rows.map(r => r.join(",")).join("\n");
      const blob = new Blob([csv], {type: "text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = alias + "_results.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);

      document.getElementById("submitBtn").disabled = true;
    });
  }
</script>
</body>
</html>
